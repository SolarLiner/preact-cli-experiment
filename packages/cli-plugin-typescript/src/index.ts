import ForkTSChecker from "fork-ts-checker-webpack-plugin";
import { PluginAPI } from "@preact/cli";

export const build = addTypeScript;
export const watch = addTypeScript;

function addTypeScript(api: PluginAPI) {
	api.chainWebpack(chain =>
		chain.module
			.rule("css-loader")
			.use("typings-for-css-modules-loader")
			.merge({
				options: {
					camelCase: true,
					banner: "// This file is automatically generated from your CSS. Any edits will be overwritten.",
					namedExport: true,
					silent: true
				}
			})
			.end()
			.end()
			.rule("typescript")
			.use("ts-loader")
			.options({ transpileOnly: true })
			.end()
			.end()
			.end()
			.plugin("ts-checker")
			.use(ForkTSChecker)
			.end()
			.resolve.extensions.merge([".ts", ".tsx"])
			.end()
			.end()
	);
}
